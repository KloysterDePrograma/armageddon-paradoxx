<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Armageddon Paradoxx</title>

  <!-- Favicon: coloque favicon.png na mesma pasta do index.html -->
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">

  <style>
    :root{
      --bg: #0b0f14;
      --panel: #101826;
      --panel2: #0f1724;
      --border: #1d2a3a;
      --text: #e8eef6;
      --muted: #a7b7cc;
      --link: #87b6ff;
      --btn: #2b78ff;
      --btn2: transparent;
      --chip: #cfe2ff;
      --danger: #ff4d4d;
    }

    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, Arial, sans-serif; background: var(--bg); color: var(--text); }

    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .app {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 100vh;
    }

    .sidebar{
      border-right: 1px solid var(--border);
      background: linear-gradient(180deg, var(--panel2), var(--bg));
      padding: 18px 14px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow: auto;
    }
    .brand{
      padding: 10px 10px 16px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 14px;
    }
    .brand h1{
      font-size: 18px;
      margin: 0 0 6px;
      letter-spacing: .2px;
    }
    .brand .muted{ font-size: 13px; color: var(--muted); }

    .navgroup{
      margin: 14px 0;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(16,24,38,.65);
    }
    .navgroup h2{
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: var(--muted);
      margin: 0 0 8px;
    }

    .navitem{
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 8px 8px;
      border-radius: 10px;
      cursor: pointer;
      align-items: center;
    }
    .navitem:hover{ background: rgba(135,182,255,.08); }
    .navitem.active{ background: rgba(43,120,255,.18); border: 1px solid rgba(43,120,255,.35); }
    .badge{
      font-size: 12px;
      color: var(--chip);
      border: 1px solid var(--border);
      padding: 2px 8px;
      border-radius: 999px;
      align-self: center;
      white-space: nowrap;
    }
    .catActions{
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .catDel{
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,77,77,.55);
      color: #ffd1d1;
      background: rgba(255,77,77,.08);
      cursor: pointer;
      user-select: none;
    }
    .catDel:hover{ background: rgba(255,77,77,.14); }

    .main{
      padding: 22px;
    }
    .topbar{
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(16,24,38,.75);
      position: sticky;
      top: 12px;
      z-index: 10;
      backdrop-filter: blur(6px);
    }
    .search{
      flex: 1;
      display: flex;
      gap: 10px;
      align-items: center;
      min-width: 220px;
    }
    .search input{
      width: 100%;
      background: rgba(11,15,20,.8);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      color: var(--text);
      outline: none;
    }
    .search input:focus{
      border-color: rgba(135,182,255,.6);
      box-shadow: 0 0 0 3px rgba(135,182,255,.12);
    }

    .actions{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
    }
    button{
      font: inherit;
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      border: 1px solid var(--border);
    }
    .primary{
      background: var(--btn);
      border-color: rgba(43,120,255,.5);
      color: white;
    }
    .ghost{
      background: var(--btn2);
      color: var(--text);
    }
    button:disabled{ opacity: .6; cursor: not-allowed; }

    .grid{
      margin-top: 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position: relative; height: auto; }
      .grid{ grid-template-columns: 1fr; }
      .topbar{ position: relative; top: 0; }
    }

    .card{
      background: rgba(16,24,38,.75);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
    }
    .card h3{ margin: 0 0 8px; font-size: 16px; }
    .muted{ color: var(--muted); font-size: 14px; }
    .status{ min-height: 20px; margin-top: 10px; white-space: pre-wrap; }

    .list{
      margin-top: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    .row{
      display: flex;
      gap: 12px;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(11,15,20,.35);
    }
    .row:last-child{ border-bottom: 0; }
    .row:hover{ background: rgba(135,182,255,.06); }
    .row .title{
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .row .title a{
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 520px;
    }
    .row .meta{ font-size: 12px; color: var(--muted); }

    .chips{ display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }
    .chip{
      font-size: 12px;
      padding: 4px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--chip);
      background: rgba(16,24,38,.4);
      white-space: nowrap;
      user-select: none;
    }
    .chip.clickable{ cursor: pointer; }
    .chip.danger{
      border-color: rgba(255,77,77,.55);
      color: #ffd1d1;
      background: rgba(255,77,77,.08);
    }
    .chip.danger:hover{
      background: rgba(255,77,77,.14);
    }

    iframe{
      width: 100%;
      height: 70vh;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--bg);
    }

    .uploadline{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 10px;
    }
    input[type="file"]{
      width: 100%;
      background: rgba(11,15,20,.35);
      border: 1px dashed rgba(29,42,58,.9);
      border-radius: 12px;
      padding: 10px 12px;
      color: var(--muted);
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.35;
    }
    .adminHint{
      margin-top: 10px;
      padding: 10px 12px;
      border: 1px dashed rgba(135,182,255,.35);
      border-radius: 12px;
      background: rgba(16,24,38,.35);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <h1>Armageddon Paradoxx</h1>
        <div class="muted">Sua “enciclopédia” de arquivos, só que sem bibliotecário.</div>
      </div>

      <div class="navgroup">
        <h2>Categorias</h2>
        <div id="cats"></div>
      </div>

      <div class="navgroup">
        <h2>Atalhos</h2>
        <div class="navitem" id="allBtn">
          <span>Todos os documentos</span>
          <span class="badge" id="totalCount">0</span>
        </div>
        <div class="muted" style="padding: 8px;">
          Dica: “categorias” aqui são pastas no Storage (ex.: <code>historia/</code>, <code>trabalhos/</code>).
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="search">
          <input id="q" placeholder="Buscar documento..." />
        </div>
        <div class="actions">
          <button id="adminBtn" class="ghost">Login Admin</button>
          <button id="refreshBtn" class="ghost">Atualizar</button>
        </div>
      </div>

      <div class="grid">
        <!-- Upload (admin only) -->
        <section class="card" id="uploadSection">
          <h3>Upload</h3>
          <div class="muted">Envie um .docx. Se quiser “categoria”, coloque no campo pasta.</div>

          <input id="folder" placeholder="Pasta/categoria (ex: Capítulo I, trabalhos, historia)" style="margin-top:10px; background: rgba(11,15,20,.8); border:1px solid var(--border); border-radius:12px; padding:10px 12px; color:var(--text); outline:none;" />
          <input id="file" type="file" accept=".docx" />

          <div class="uploadline">
            <button id="uploadBtn" class="primary">Upload</button>
          </div>

          <div id="status" class="status muted"></div>

          <div class="adminHint">
            Admin: faça login para poder fazer upload e apagar arquivos/categorias.
          </div>

          <div class="hint">
            Para “admin-only” funcionar de verdade, o Supabase precisa ter policy de <code>INSERT</code>/<code>DELETE</code> só pra <code>authenticated</code>.
          </div>
        </section>

        <section class="card">
          <h3>Leitor</h3>
          <div class="muted" id="readingMeta">Selecione um documento na lista.</div>
          <div id="viewerWrap" style="margin-top: 12px;">
            <div class="muted">Nada aberto.</div>
          </div>
        </section>
      </div>

      <section class="card" style="margin-top:16px;">
        <h3 id="listTitle">Documentos</h3>
        <div class="muted" id="listSubtitle">Mostrando tudo.</div>

        <div class="list" id="list"></div>
        <div class="muted" id="empty" style="display:none; padding: 10px 2px;">Nenhum documento encontrado.</div>
      </section>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Configure aqui
    const SUPABASE_URL = "https://tqdqqbqmcmctozgzlpxs.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_eYs2DCkzhe0JlKhfRJra-Q_96_tH2i9";
    const BUCKET = "docs";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const qEl = document.getElementById("q");
    const catsEl = document.getElementById("cats");
    const totalCountEl = document.getElementById("totalCount");
    const allBtn = document.getElementById("allBtn");

    const uploadSection = document.getElementById("uploadSection");
    const folderEl = document.getElementById("folder");
    const fileInput = document.getElementById("file");
    const uploadBtn = document.getElementById("uploadBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const adminBtn = document.getElementById("adminBtn");
    const statusEl = document.getElementById("status");

    const listTitle = document.getElementById("listTitle");
    const listSubtitle = document.getElementById("listSubtitle");
    const listEl = document.getElementById("list");
    const emptyEl = document.getElementById("empty");

    const readingMeta = document.getElementById("readingMeta");
    const viewerWrap = document.getElementById("viewerWrap");

    let allFiles = []; // { name, updated_at, publicUrl }
    let activeFolder = ""; // "" = tudo, "__root__" = sem categoria, ou "Capítulo_I"
    let currentUser = null;

    function setStatus(msg){ statusEl.textContent = msg || ""; }

    // Nome do arquivo: mantém simples
    function safeName(name){
      return name.replace(/[^\w.\- ]+/g, "_").trim();
    }

    // Pasta/categoria:
    // - mantém acentos (Capítulo)
    // - troca espaços por "_" só para o path ficar consistente
    // - remove barras no começo/fim
    function safeFolder(folder){
      if (!folder) return "";
      return folder
        .trim()
        .replace(/\\/g, "/")
        .replace(/^\/+|\/+$/g, "")
        .replace(/\s+/g, "_");
    }

    // Exibição amigável:
    // - mostra "_" como espaço (Capítulo_I -> Capítulo I)
    function displayFolderName(name){
      return (name || "").replace(/_/g, " ").trim();
    }

    function updateAuthUI(){
      if (currentUser) {
        adminBtn.textContent = "Sair (Admin)";
        uploadSection.style.display = "block";
      } else {
        adminBtn.textContent = "Login Admin";
        uploadSection.style.display = "none";
      }
    }

    async function checkUser(){
      const { data } = await supabaseClient.auth.getUser();
      currentUser = data?.user || null;
      updateAuthUI();
    }

    async function loginAdmin(){
      const email = prompt("Email admin:");
      const password = prompt("Senha:");
      if (!email || !password) return;

      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) return alert("Erro no login: " + error.message);

      await checkUser();
      await refreshAll();
    }

    async function logoutAdmin(){
      await supabaseClient.auth.signOut();
      currentUser = null;
      updateAuthUI();
      await refreshAll();
    }

    async function uploadDocx(){
      if (!currentUser) return setStatus("Só admin pode fazer upload.");
      const file = fileInput.files?.[0];
      if (!file) return setStatus("Escolhe um .docx primeiro.");
      if (!file.name.toLowerCase().endsWith(".docx")) return setStatus("Só aceito .docx.");

      uploadBtn.disabled = true;
      setStatus("Enviando...");

      const folder = safeFolder(folderEl.value);
      const clean = safeName(file.name);
      const stamp = new Date().toISOString().replace(/[:.]/g, "-");
      const path = (folder ? folder + "/" : "") + `${stamp}__${clean}`;

      const { error } = await supabaseClient.storage
        .from(BUCKET)
        .upload(path, file, {
          upsert: false,
          contentType: file.type || "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
        });

      uploadBtn.disabled = false;

      if (error) return setStatus("Falhou no upload: " + error.message);

      setStatus("Upload feito: " + clean);
      fileInput.value = "";
      await refreshAll();
    }

    async function deleteFile(fullPath){
      if (!currentUser) return alert("Você precisa estar logado como admin pra apagar.");

      const ok = confirm("Apagar este arquivo?\n\n" + fullPath);
      if (!ok) return;

      const { error } = await supabaseClient.storage
        .from(BUCKET)
        .remove([fullPath]);

      if (error) return alert("Erro ao apagar: " + error.message);
      await refreshAll();
    }

    // Deleta “categoria” = apaga todos os arquivos com prefixo "categoria/"
    async function deleteCategory(categoryKey){
      if (!currentUser) return alert("Só admin pode apagar categoria.");
      if (!categoryKey || categoryKey === "__root__") return alert("Não dá pra apagar a categoria raiz.");

      const nice = displayFolderName(categoryKey);
      const ok = confirm(`Apagar TODA a categoria "${nice}"?\n\nIsso apaga todos os .docx dentro dela.`);
      if (!ok) return;

      const filesToDelete = allFiles
        .filter(f => f.name.startsWith(categoryKey + "/"))
        .map(f => f.name);

      if (!filesToDelete.length) return alert("Categoria vazia.");

      const { error } = await supabaseClient.storage
        .from(BUCKET)
        .remove(filesToDelete);

      if (error) return alert("Erro ao apagar categoria: " + error.message);
      await refreshAll();
    }

    async function listRecursive(prefix=""){
      const { data, error } = await supabaseClient.storage.from(BUCKET).list(prefix, {
        limit: 100,
        sortBy: { column: "name", order: "asc" }
      });
      if (error) throw error;

      const files = [];
      for (const item of data){
        if (!item.name) continue;
        const full = prefix ? `${prefix}/${item.name}` : item.name;

        const isDocx = full.toLowerCase().endsWith(".docx");
        if (isDocx){
          const { data: pub } = supabaseClient.storage.from(BUCKET).getPublicUrl(full);
          files.push({
            name: full,
            updated_at: item.updated_at || item.created_at || null,
            publicUrl: pub.publicUrl
          });
        } else {
          try {
            const sub = await listRecursive(full);
            files.push(...sub);
          } catch (e) {
            // ignora pastas que falham
          }
        }
      }
      return files;
    }

    function buildCategories(files){
      const counts = new Map();
      for (const f of files){
        const parts = f.name.split("/");
        const cat = (parts.length > 1) ? parts[0] : "Sem categoria";
        counts.set(cat, (counts.get(cat) || 0) + 1);
      }

      const cats = [...counts.entries()].sort((a,b)=>{
        if (a[0] === "Sem categoria") return 1;
        if (b[0] === "Sem categoria") return -1;
        return a[0].localeCompare(b[0]);
      });

      catsEl.innerHTML = "";

      for (const [cat, n] of cats){
        const key = (cat === "Sem categoria") ? "__root__" : cat;

        const div = document.createElement("div");
        div.className = "navitem" + (activeFolder === key ? " active" : "");
        div.dataset.key = key;

        div.onclick = () => {
          activeFolder = key;
          render();
          highlightCats();
        };

        const left = document.createElement("span");
        left.textContent = (cat === "Sem categoria") ? cat : displayFolderName(cat);

        const actions = document.createElement("div");
        actions.className = "catActions";

        const badge = document.createElement("span");
        badge.className = "badge";
        badge.textContent = n;

        actions.appendChild(badge);

        if (currentUser && cat !== "Sem categoria") {
          const del = document.createElement("span");
          del.className = "catDel";
          del.textContent = "Apagar";
          del.title = "Apagar categoria (remove todos os arquivos)";
          del.onclick = (e) => {
            e.stopPropagation();
            deleteCategory(cat);
          };
          actions.appendChild(del);
        }

        div.appendChild(left);
        div.appendChild(actions);
        catsEl.appendChild(div);
      }
    }

    function highlightCats(){
      [...catsEl.children].forEach(el => {
        el.classList.toggle("active", el.dataset.key === activeFolder);
      });
      allBtn.classList.toggle("active", activeFolder === "");
    }

    function filterFiles(){
      const term = qEl.value.trim().toLowerCase();
      return allFiles.filter(f => {
        const parts = f.name.split("/");
        const catKey = (parts.length > 1) ? parts[0] : "__root__";
        const folderOk = !activeFolder || catKey === activeFolder;
        const textOk = !term || f.name.toLowerCase().includes(term);
        return folderOk && textOk;
      });
    }

    function prettyTitle(path){
      const base = path.split("/").pop();
      return base.replace(/^\d{4}-\d{2}-\d{2}T.*?__/, "");
    }

    function openInViewer(file){
      const viewerUrl = "https://view.officeapps.live.com/op/embed.aspx?src=" + encodeURIComponent(file.publicUrl);
      const raw = file.name.includes("/") ? file.name.split("/")[0] : "Sem categoria";
      const nice = raw === "Sem categoria" ? raw : displayFolderName(raw);
      readingMeta.textContent = `Lendo: ${prettyTitle(file.name)} • ${nice}`;

      viewerWrap.innerHTML = `
        <iframe src="${viewerUrl}" loading="lazy" referrerpolicy="no-referrer"></iframe>
        <div class="muted" style="margin-top:10px;">
          <a href="${file.publicUrl}" target="_blank" rel="noopener">Abrir link direto</a> (para baixar ou compartilhar).
        </div>
      `;
    }

    function render(){
      const filtered = filterFiles();
      listEl.innerHTML = "";
      emptyEl.style.display = filtered.length ? "none" : "block";

      const folderLabel = activeFolder
        ? (activeFolder === "__root__" ? "Sem categoria" : displayFolderName(activeFolder))
        : "Tudo";

      listTitle.textContent = `Documentos • ${folderLabel}`;
      listSubtitle.textContent = qEl.value.trim()
        ? `Filtrando por: "${qEl.value.trim()}"`
        : (activeFolder ? "Mostrando somente essa categoria." : "Mostrando tudo.");

      for (const f of filtered){
        const row = document.createElement("div");
        row.className = "row";

        const title = document.createElement("div");
        title.className = "title";

        const a = document.createElement("a");
        a.href = "#";
        a.textContent = prettyTitle(f.name);
        a.onclick = (e)=>{ e.preventDefault(); openInViewer(f); };

        const meta = document.createElement("div");
        meta.className = "meta";

        const catRaw = f.name.includes("/") ? f.name.split("/")[0] : "Sem categoria";
        const catNice = (catRaw === "Sem categoria") ? catRaw : displayFolderName(catRaw);
        const when = f.updated_at ? new Date(f.updated_at).toLocaleString() : "";
        meta.textContent = `${catNice}${when ? " • " + when : ""}`.trim();

        title.appendChild(a);
        title.appendChild(meta);

        const chips = document.createElement("div");
        chips.className = "chips";

        const chipOpen = document.createElement("span");
        chipOpen.className = "chip clickable";
        chipOpen.textContent = "Abrir";
        chipOpen.onclick = () => openInViewer(f);

        const chipDl = document.createElement("a");
        chipDl.className = "chip";
        chipDl.href = f.publicUrl;
        chipDl.target = "_blank";
        chipDl.rel = "noopener";
        chipDl.textContent = "Link";

        chips.appendChild(chipOpen);
        chips.appendChild(chipDl);

        if (currentUser) {
          const chipDelete = document.createElement("span");
          chipDelete.className = "chip danger clickable";
          chipDelete.textContent = "Apagar";
          chipDelete.onclick = () => deleteFile(f.name);
          chips.appendChild(chipDelete);
        }

        row.appendChild(title);
        row.appendChild(chips);
        listEl.appendChild(row);
      }

      totalCountEl.textContent = allFiles.length;
    }

    async function refreshAll(){
      setStatus("Carregando…");
      listEl.innerHTML = "";
      emptyEl.style.display = "none";

      try{
        const files = await listRecursive("");
        files.sort((a,b)=> (new Date(b.updated_at||0)) - (new Date(a.updated_at||0)));
        allFiles = files;

        buildCategories(allFiles);
        highlightCats();
        render();

        setStatus("");
      } catch (e){
        setStatus("Erro ao carregar: " + (e?.message || e));
      }
    }

    // eventos
    uploadBtn.addEventListener("click", uploadDocx);
    refreshBtn.addEventListener("click", refreshAll);

    adminBtn.addEventListener("click", async () => {
      if (currentUser) await logoutAdmin();
      else await loginAdmin();
    });

    allBtn.addEventListener("click", ()=>{
      activeFolder = "";
      qEl.value = "";
      highlightCats();
      render();
    });

    qEl.addEventListener("input", ()=> render());

    // init
    (async () => {
      await checkUser();
      await refreshAll();
    })();
  </script>
</body>
</html>
